<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rhythm Room - Music Producer App</title>
    <script src="https://unpkg.com/tone@14.7.77/build/Tone.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @import url('https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Exo+2:wght@300;400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Exo 2', 'Orbitron', 'Arial', sans-serif;
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
            color: #e5e5e5;
            min-height: 100vh;
            font-weight: 400;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        .container {
            max-width: 100vw;
            margin: 0;
            padding: 0.5rem;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            padding: 0.5rem 0;
        }

        .logo {
            display: flex;
            align-items: center;
            font-family: 'Exo 2', 'Orbitron', 'Arial', sans-serif;
            font-size: 1.2rem;
            font-weight: 600;
            color: #ffffff;
            text-shadow: 
                0 0 8px rgba(255, 255, 255, 0.2),
                0 1px 3px rgba(0, 0, 0, 0.4);
            letter-spacing: -0.5px;
            margin: 0;
            text-transform: lowercase;
        }

        /* Soft Gradient 3D Cube Logo Styles */
        .cube-container {
            perspective: 1200px;
            perspective-origin: center center;
            margin-right: 1rem;
        }

        .cube {
            position: relative;
            width: 20px;
            height: 20px;
            transform-style: preserve-3d;
            animation: simpleRotate 8s infinite linear;
        }

        .face {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .front {
            transform: rotateY(0deg) translateZ(10px);
            background: #f0f0f0;
        }

        .back {
            transform: rotateY(180deg) translateZ(10px);
            background: #d0d0d0;
        }

        .right {
            transform: rotateY(90deg) translateZ(10px);
            background: #a0a0a0;
        }

        .left {
            transform: rotateY(-90deg) translateZ(10px);
            background: #808080;
        }

        .top {
            transform: rotateX(90deg) translateZ(10px);
            background: #ffffff;
        }

        .bottom {
            transform: rotateX(-90deg) translateZ(10px);
            background: #606060;
        }

        @keyframes simpleRotate {
            0% {
                transform: rotateX(0deg) rotateY(0deg);
            }
            100% {
                transform: rotateX(360deg) rotateY(360deg);
            }
        }

        .timeline-tabs {
            margin-bottom: 1rem;
            border-bottom: 1px solid #333333;
        }

        .tabs-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0;
        }

        .tabs-list {
            display: flex;
            gap: 0.25rem;
            flex: 1;
            overflow-x: auto;
        }

        .timeline-tab {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: linear-gradient(145deg, #2a2a2a 0%, #1a1a1a 100%);
            border: 1px solid #333333;
            border-radius: 0.5rem 0.5rem 0 0;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 120px;
            position: relative;
        }

        .timeline-tab:hover {
            background: linear-gradient(145deg, #3a3a3a 0%, #2a2a2a 100%);
            border-color: #555555;
        }

        .timeline-tab.active {
            background: linear-gradient(145deg, #00ff88 0%, #00cc6a 100%);
            border-color: #00ff88;
            color: #000000;
        }

        .timeline-tab.active .tab-name {
            color: #000000;
        }

        .tab-name {
            flex: 1;
            font-size: 0.875rem;
            font-weight: 500;
            color: #ffffff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tab-rename-btn {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .tab-rename-btn:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.1);
        }

        .tab-close-btn {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
            opacity: 0.7;
            transition: all 0.2s;
        }

        .tab-close-btn:hover {
            opacity: 1;
            background: rgba(255, 0, 0, 0.2);
            color: #ff6b6b;
        }

        .add-tab-btn {
            background: linear-gradient(145deg, #4a4a4a 0%, #3a3a3a 100%);
            border: 1px solid #555555;
            color: #ffffff;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.2s ease;
            min-width: 40px;
        }

        .add-tab-btn:hover {
            background: linear-gradient(145deg, #5a5a5a 0%, #4a4a4a 100%);
            border-color: #00ff88;
            color: #00ff88;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 1rem;
            flex: 1;
            min-height: 0;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: linear-gradient(145deg, #1a1a1a 0%, #2a2a2a 100%);
            border: 1px solid #333333;
            border-radius: 0.5rem;
            padding: 1rem;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .panel h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            text-align: center;
        }

        .instrument-button {
            width: 100%;
            padding: 0.75rem 1rem;
            margin-bottom: 0.75rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
            border: 1px solid #4b5563;
            background-color: #1f2937;
            color: #f9fafb;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .instrument-button:hover {
            background-color: #6366f1;
            transform: scale(1.05);
        }

        .instrument-button.selected {
            background-color: #6366f1;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transform: scale(1.05);
        }

        .instrument-button:active {
            transform: scale(0.95);
        }

        .instrument-button div {
            text-align: left;
        }

        .pro-tips {
            text-align: left;
        }

        .pro-tips h3 {
            text-align: left;
        }

        .pro-tips ul {
            text-align: left;
        }

        .timeline-grid {
            background: linear-gradient(145deg, #0a0a0a 0%, #1a1a1a 100%);
            border: 1px solid #333333;
            border-radius: 0.5rem;
            padding: 0.5rem;
            overflow-x: auto;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
        }

        .timeline-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        .timeline-cell {
            width: 2.5rem;
            height: 2.5rem;
            border: 1px solid #333333;
            text-align: center;
            vertical-align: middle;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.2rem;
            background: linear-gradient(145deg, #1a1a1a 0%, #2a2a2a 100%);
        }

        .timeline-cell:hover {
            border-color: #00ff88;
            background: linear-gradient(145deg, #2a2a2a 0%, #3a3a3a 100%);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.2);
        }

        .timeline-cell.active {
            background: linear-gradient(145deg, #00ff88 0%, #00cc6a 100%);
            border-color: #00ff88;
            color: #000000;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.4);
        }

        .timeline-cell.current-step {
            box-shadow: 0 0 0 2px #00ff88;
        }

        .timeline-cell.has-instrument {
            background-color: #6366f1;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .timeline-cell.has-instrument.drums {
            background: linear-gradient(145deg, #ff4444 0%, #cc3333 100%);
            box-shadow: 0 0 15px rgba(255, 68, 68, 0.4);
        }

        .timeline-cell.has-instrument.piano {
            background: linear-gradient(145deg, #4488ff 0%, #3366cc 100%);
            box-shadow: 0 0 15px rgba(68, 136, 255, 0.4);
        }

        .timeline-cell.has-instrument.synth {
            background: linear-gradient(145deg, #8844ff 0%, #6633cc 100%);
            box-shadow: 0 0 15px rgba(136, 68, 255, 0.4);
        }




        .controls {
            background: linear-gradient(145deg, #1a1a1a 0%, #2a2a2a 100%);
            border: 1px solid #333333;
            border-radius: 0.5rem;
            padding: 0.75rem;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            margin-top: 0.5rem;
        }

        .controls-grid {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
        }

        @media (min-width: 640px) {
            .controls-grid {
                flex-direction: row;
                justify-content: center;
                flex-wrap: wrap;
            }
        }

        .play-button {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: bold;
            font-size: 0.875rem;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
        }

        .play-button.playing {
            background: linear-gradient(145deg, #ff4444 0%, #cc3333 100%);
            color: white;
            box-shadow: 0 0 20px rgba(255, 68, 68, 0.4);
        }

        .play-button:not(.playing) {
            background: linear-gradient(145deg, #00ff88 0%, #00cc6a 100%);
            color: #000000;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.4);
        }

        .play-button:hover {
            transform: scale(1.05);
        }

        .play-button:active {
            transform: scale(0.95);
        }

        .tempo-control {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .tempo-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #888888;
        }

        .tempo-slider-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .tempo-button {
            padding: 0.5rem 0.75rem;
            background: linear-gradient(145deg, #2a2a2a 0%, #3a3a3a 100%);
            color: #e5e5e5;
            border: 1px solid #444444;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tempo-button:hover {
            background: linear-gradient(145deg, #00ff88 0%, #00cc6a 100%);
            color: #000000;
            border-color: #00ff88;
        }

        .tempo-slider {
            width: 8rem;
            height: 0.5rem;
            background: #2a2a2a;
            border-radius: 0.25rem;
            outline: none;
            cursor: pointer;
        }

        .tempo-slider::-webkit-slider-thumb {
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            background: linear-gradient(145deg, #00ff88 0%, #00cc6a 100%);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.4);
        }

        .tempo-presets {
            display: flex;
            gap: 0.5rem;
        }

        .preset-button {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            background: linear-gradient(145deg, #2a2a2a 0%, #3a3a3a 100%);
            color: #e5e5e5;
            border: 1px solid #444444;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preset-button:hover {
            background: linear-gradient(145deg, #00ff88 0%, #00cc6a 100%);
            color: #000000;
            border-color: #00ff88;
        }

        .tooltip {
            position: fixed;
            background-color: #f59e0b;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            z-index: 1000;
            pointer-events: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        .pro-tips {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: #1f2937;
            border-radius: 0.5rem;
        }

        .pro-tips h3 {
            font-size: 0.875rem;
            font-weight: 500;
            color: #f59e0b;
            margin-bottom: 0.5rem;
        }

        .pro-tips ul {
            font-size: 0.75rem;
            color: #9ca3af;
            list-style: none;
            padding: 0;
        }

        .pro-tips li {
            margin-bottom: 0.25rem;
        }

        .pro-tips li:before {
            content: "• ";
            color: #f59e0b;
        }

        .status-message {
            margin-top: 1rem;
            padding: 0.75rem;
            background-color: #6366f1;
            color: white;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            text-align: center;
        }

        .hidden {
            display: none;
        }

        .note-selector {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #1f2937;
            border-radius: 0.5rem;
            border: 1px solid #4b5563;
        }

        .note-selector h3 {
            font-size: 0.875rem;
            font-weight: 500;
            color: #f59e0b;
            margin-bottom: 0.75rem;
            text-align: center;
        }

        .piano-roll {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 0.25rem;
            margin-bottom: 0.75rem;
        }

        .note-button {
            padding: 0.5rem 0.25rem;
            border: 1px solid #4b5563;
            border-radius: 0.25rem;
            background-color: #374151;
            color: #f9fafb;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .note-button:hover {
            background-color: #6366f1;
            border-color: #6366f1;
        }

        .note-button.selected {
            background-color: #f59e0b;
            border-color: #f59e0b;
            color: #1f2937;
        }

        .chord-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .chord-button {
            padding: 0.5rem 0.75rem;
            border: 1px solid #4b5563;
            border-radius: 0.25rem;
            background-color: #374151;
            color: #f9fafb;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chord-button:hover {
            background-color: #8b5cf6;
            border-color: #8b5cf6;
        }

        .chord-button.selected {
            background-color: #8b5cf6;
            border-color: #8b5cf6;
        }

        .note-info {
            font-size: 0.75rem;
            color: #9ca3af;
            text-align: center;
            margin-top: 0.5rem;
        }

        .timeline-cell.note-cell {
            position: relative;
            font-size: 0.75rem;
            padding: 0.25rem;
        }

        .note-display {
            font-size: 0.75rem;
            font-weight: 500;
            margin-top: 0.25rem;
        }

        .wave-visualizer {
            height: 60px;
            background: linear-gradient(145deg, #0a0a0a 0%, #1a1a1a 100%);
            border: 1px solid #333333;
            border-radius: 0.25rem;
            margin: 0.5rem 0;
            position: relative;
            overflow: hidden;
        }

        .wave-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .export-progress {
            margin: 1rem 0;
            padding: 1rem;
            background: linear-gradient(145deg, #1a1a1a 0%, #2a2a2a 100%);
            border: 1px solid #333333;
            border-radius: 0.5rem;
        }

        .export-progress.hidden {
            display: none;
        }

        .progress-label {
            text-align: center;
            font-size: 0.875rem;
            color: #00ff88;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #333333;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff88 0%, #00cc6a 100%);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .progress-text {
            text-align: center;
            font-size: 0.75rem;
            color: #888888;
        }

        .loop-control {
            margin: 1rem 0;
            text-align: center;
        }

        .loop-checkbox-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            color: #ffffff;
            user-select: none;
        }

        .loop-checkbox-label input[type="checkbox"] {
            display: none;
        }

        .checkmark {
            width: 18px;
            height: 18px;
            background: #333333;
            border: 2px solid #555555;
            border-radius: 3px;
            position: relative;
            transition: all 0.2s ease;
        }

        .loop-checkbox-label input[type="checkbox"]:checked + .checkmark {
            background: #00ff88;
            border-color: #00ff88;
        }

        .loop-checkbox-label input[type="checkbox"]:checked + .checkmark::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #000000;
            font-weight: bold;
            font-size: 12px;
        }

        .row-control-btn {
            transition: all 0.2s;
            font-family: 'Work Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        }

        .row-control-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .row-control-btn:active {
            transform: scale(0.95);
        }

        .row-control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .column-control-btn {
            transition: all 0.2s;
            font-family: 'Work Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        }

        .column-control-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .column-control-btn:active {
            transform: scale(0.95);
        }

        .column-control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Custom scrollbar styling */
        .panel::-webkit-scrollbar {
            width: 8px;
        }

        .panel::-webkit-scrollbar-track {
            background: #1a1a1a;
            border-radius: 4px;
        }

        .panel::-webkit-scrollbar-thumb {
            background: linear-gradient(145deg, #00ff88 0%, #00cc6a 100%);
            border-radius: 4px;
        }

        .panel::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(145deg, #00cc6a 0%, #00aa55 100%);
        }

        /* Firefox scrollbar */
        .panel {
            scrollbar-width: thin;
            scrollbar-color: #00ff88 #1a1a1a;
        }

        /* Timeline grid scrollbar */
        .timeline-grid::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .timeline-grid::-webkit-scrollbar-track {
            background: #0a0a0a;
            border-radius: 4px;
        }

        .timeline-grid::-webkit-scrollbar-thumb {
            background: linear-gradient(145deg, #00ff88 0%, #00cc6a 100%);
            border-radius: 4px;
        }

        .timeline-grid::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(145deg, #00cc6a 0%, #00aa55 100%);
        }

        .timeline-grid {
            scrollbar-width: thin;
            scrollbar-color: #00ff88 #0a0a0a;
        }

        .wave-label {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            color: #888888;
            font-size: 0.75rem;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">
                <div class="cube-container">
                    <div class="cube">
                        <div class="face front"></div>
                        <div class="face back"></div>
                        <div class="face right"></div>
                        <div class="face left"></div>
                        <div class="face top"></div>
                        <div class="face bottom"></div>
                    </div>
                </div>
                Rhythm Room
            </div>
            <div id="audio-status" style="margin-top: 0.5rem; padding: 0.25rem 0.5rem; background-color: #374151; border-radius: 0.25rem; display: inline-block; font-size: 0.75rem;">
                <span id="audio-status-text">🔇 Click anywhere to enable audio</span>
            </div>
        </header>

        <!-- Timeline Tabs -->
        <div class="timeline-tabs">
            <div class="tabs-container">
                <div class="tabs-list" id="tabs-list">
                    <!-- Tabs will be dynamically added here -->
                </div>
                <button id="add-tab-btn" class="add-tab-btn" title="Add New Timeline">+</button>
            </div>
        </div>

        <div class="main-grid">
            <!-- Instrument Panel -->
            <div class="panel">
                <h2>Instruments</h2>
                <button class="instrument-button" data-instrument="drums">
                    <span>🥁</span>
                    <div>
                        <div>Drums</div>
                        <div style="font-size: 0.75rem; opacity: 0.7;">Rhythm foundation</div>
                    </div>
                </button>
                <button class="instrument-button" data-instrument="piano">
                    <span>🎹</span>
                    <div>
                        <div>Piano</div>
                        <div style="font-size: 0.75rem; opacity: 0.7;">Melodic harmony</div>
                    </div>
                </button>
                <button class="instrument-button" data-instrument="synth">
                    <span>🎛️</span>
                    <div>
                        <div>Synth</div>
                        <div style="font-size: 0.75rem; opacity: 0.7;">Electronic sounds</div>
                    </div>
                </button>
                <button class="instrument-button" data-instrument="guitar">
                    <span>🎸</span>
                    <div>
                        <div>Electric Guitar</div>
                        <div style="font-size: 0.75rem; opacity: 0.7;">Rock & electric</div>
                    </div>
                </button>

                <div id="status-message" class="status-message hidden">
                    <span id="status-text"></span>
                </div>

                <!-- Note Selector -->
                <div id="note-selector" class="note-selector hidden">
                    <h3>🎵 Select Notes & Chords</h3>
                    
                    <!-- Piano Roll -->
                    <div class="piano-roll" id="piano-roll">
                        <!-- Notes will be generated by JavaScript -->
                    </div>
                    
                    <!-- Chord Selector -->
                    <div class="chord-selector" id="chord-selector">
                        <button class="chord-button" data-chord="single">Single Note</button>
                        <button class="chord-button" data-chord="major">Major</button>
                        <button class="chord-button" data-chord="minor">Minor</button>
                        <button class="chord-button" data-chord="seventh">7th</button>
                        <button class="chord-button" data-chord="sus2">Sus2</button>
                        <button class="chord-button" data-chord="sus4">Sus4</button>
                    </div>
                    
                    <div class="note-info">
                        <span id="selected-note-info">Select a note above</span>
                    </div>
                </div>

                <div class="pro-tips">
                    <h3>💡 Pro Tips</h3>
                    <ul>
                        <li>Start with drums for rhythm</li>
                        <li>Layer piano for melody</li>
                        <li>Add synth for texture</li>
                        <li>Try different tempos</li>
                    </ul>
                </div>
            </div>

            <!-- Timeline -->
            <div class="panel">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 style="margin: 0;">Timeline</h2>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <div style="display: flex; gap: 0.25rem;">
                            <button id="add-row-btn" class="row-control-btn" style="background: linear-gradient(145deg, #00ff88 0%, #00cc6a 100%); color: #000; border: none; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; cursor: pointer; font-weight: bold;">+ Row</button>
                            <button id="remove-row-btn" class="row-control-btn" style="background: linear-gradient(145deg, #ff4444 0%, #cc3333 100%); color: #fff; border: none; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; cursor: pointer; font-weight: bold;">- Row</button>
                        </div>
                        <div style="display: flex; gap: 0.25rem;">
                            <button id="add-column-btn" class="column-control-btn" style="background: linear-gradient(145deg, #8844ff 0%, #6633cc 100%); color: #fff; border: none; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; cursor: pointer; font-weight: bold;">+ Col</button>
                            <button id="remove-column-btn" class="column-control-btn" style="background: linear-gradient(145deg, #ff8844 0%, #cc6633 100%); color: #fff; border: none; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; cursor: pointer; font-weight: bold;">- Col</button>
                        </div>
                    </div>
                </div>
                <div class="timeline-grid">
                    <table class="timeline-table">
                        <tbody>
                            <tr>
                                <td class="timeline-cell" data-row="0" data-col="0"></td>
                                <td class="timeline-cell" data-row="0" data-col="1"></td>
                                <td class="timeline-cell" data-row="0" data-col="2"></td>
                                <td class="timeline-cell" data-row="0" data-col="3"></td>
                                <td class="timeline-cell" data-row="0" data-col="4"></td>
                                <td class="timeline-cell" data-row="0" data-col="5"></td>
                                <td class="timeline-cell" data-row="0" data-col="6"></td>
                                <td class="timeline-cell" data-row="0" data-col="7"></td>
                                <td class="timeline-cell" data-row="0" data-col="8"></td>
                                <td class="timeline-cell" data-row="0" data-col="9"></td>
                                <td class="timeline-cell" data-row="0" data-col="10"></td>
                                <td class="timeline-cell" data-row="0" data-col="11"></td>
                                <td class="timeline-cell" data-row="0" data-col="12"></td>
                                <td class="timeline-cell" data-row="0" data-col="13"></td>
                                <td class="timeline-cell" data-row="0" data-col="14"></td>
                                <td class="timeline-cell" data-row="0" data-col="15"></td>
                            </tr>
                            <tr>
                                <td class="timeline-cell" data-row="1" data-col="0"></td>
                                <td class="timeline-cell" data-row="1" data-col="1"></td>
                                <td class="timeline-cell" data-row="1" data-col="2"></td>
                                <td class="timeline-cell" data-row="1" data-col="3"></td>
                                <td class="timeline-cell" data-row="1" data-col="4"></td>
                                <td class="timeline-cell" data-row="1" data-col="5"></td>
                                <td class="timeline-cell" data-row="1" data-col="6"></td>
                                <td class="timeline-cell" data-row="1" data-col="7"></td>
                                <td class="timeline-cell" data-row="1" data-col="8"></td>
                                <td class="timeline-cell" data-row="1" data-col="9"></td>
                                <td class="timeline-cell" data-row="1" data-col="10"></td>
                                <td class="timeline-cell" data-row="1" data-col="11"></td>
                                <td class="timeline-cell" data-row="1" data-col="12"></td>
                                <td class="timeline-cell" data-row="1" data-col="13"></td>
                                <td class="timeline-cell" data-row="1" data-col="14"></td>
                                <td class="timeline-cell" data-row="1" data-col="15"></td>
                            </tr>
                            <tr>
                                <td class="timeline-cell" data-row="2" data-col="0"></td>
                                <td class="timeline-cell" data-row="2" data-col="1"></td>
                                <td class="timeline-cell" data-row="2" data-col="2"></td>
                                <td class="timeline-cell" data-row="2" data-col="3"></td>
                                <td class="timeline-cell" data-row="2" data-col="4"></td>
                                <td class="timeline-cell" data-row="2" data-col="5"></td>
                                <td class="timeline-cell" data-row="2" data-col="6"></td>
                                <td class="timeline-cell" data-row="2" data-col="7"></td>
                                <td class="timeline-cell" data-row="2" data-col="8"></td>
                                <td class="timeline-cell" data-row="2" data-col="9"></td>
                                <td class="timeline-cell" data-row="2" data-col="10"></td>
                                <td class="timeline-cell" data-row="2" data-col="11"></td>
                                <td class="timeline-cell" data-row="2" data-col="12"></td>
                                <td class="timeline-cell" data-row="2" data-col="13"></td>
                                <td class="timeline-cell" data-row="2" data-col="14"></td>
                                <td class="timeline-cell" data-row="2" data-col="15"></td>
                            </tr>
                            <tr>
                                <td class="timeline-cell" data-row="3" data-col="0"></td>
                                <td class="timeline-cell" data-row="3" data-col="1"></td>
                                <td class="timeline-cell" data-row="3" data-col="2"></td>
                                <td class="timeline-cell" data-row="3" data-col="3"></td>
                                <td class="timeline-cell" data-row="3" data-col="4"></td>
                                <td class="timeline-cell" data-row="3" data-col="5"></td>
                                <td class="timeline-cell" data-row="3" data-col="6"></td>
                                <td class="timeline-cell" data-row="3" data-col="7"></td>
                                <td class="timeline-cell" data-row="3" data-col="8"></td>
                                <td class="timeline-cell" data-row="3" data-col="9"></td>
                                <td class="timeline-cell" data-row="3" data-col="10"></td>
                                <td class="timeline-cell" data-row="3" data-col="11"></td>
                                <td class="timeline-cell" data-row="3" data-col="12"></td>
                                <td class="timeline-cell" data-row="3" data-col="13"></td>
                                <td class="timeline-cell" data-row="3" data-col="14"></td>
                                <td class="timeline-cell" data-row="3" data-col="15"></td>
                            </tr>
                            <tr>
                                <td class="timeline-cell" data-row="4" data-col="0"></td>
                                <td class="timeline-cell" data-row="4" data-col="1"></td>
                                <td class="timeline-cell" data-row="4" data-col="2"></td>
                                <td class="timeline-cell" data-row="4" data-col="3"></td>
                                <td class="timeline-cell" data-row="4" data-col="4"></td>
                                <td class="timeline-cell" data-row="4" data-col="5"></td>
                                <td class="timeline-cell" data-row="4" data-col="6"></td>
                                <td class="timeline-cell" data-row="4" data-col="7"></td>
                                <td class="timeline-cell" data-row="4" data-col="8"></td>
                                <td class="timeline-cell" data-row="4" data-col="9"></td>
                                <td class="timeline-cell" data-row="4" data-col="10"></td>
                                <td class="timeline-cell" data-row="4" data-col="11"></td>
                                <td class="timeline-cell" data-row="4" data-col="12"></td>
                                <td class="timeline-cell" data-row="4" data-col="13"></td>
                                <td class="timeline-cell" data-row="4" data-col="14"></td>
                                <td class="timeline-cell" data-row="4" data-col="15"></td>
                            </tr>
                            <tr>
                                <td class="timeline-cell" data-row="5" data-col="0"></td>
                                <td class="timeline-cell" data-row="5" data-col="1"></td>
                                <td class="timeline-cell" data-row="5" data-col="2"></td>
                                <td class="timeline-cell" data-row="5" data-col="3"></td>
                                <td class="timeline-cell" data-row="5" data-col="4"></td>
                                <td class="timeline-cell" data-row="5" data-col="5"></td>
                                <td class="timeline-cell" data-row="5" data-col="6"></td>
                                <td class="timeline-cell" data-row="5" data-col="7"></td>
                                <td class="timeline-cell" data-row="5" data-col="8"></td>
                                <td class="timeline-cell" data-row="5" data-col="9"></td>
                                <td class="timeline-cell" data-row="5" data-col="10"></td>
                                <td class="timeline-cell" data-row="5" data-col="11"></td>
                                <td class="timeline-cell" data-row="5" data-col="12"></td>
                                <td class="timeline-cell" data-row="5" data-col="13"></td>
                                <td class="timeline-cell" data-row="5" data-col="14"></td>
                                <td class="timeline-cell" data-row="5" data-col="15"></td>
                            </tr>
                            <tr>
                                <td class="timeline-cell" data-row="6" data-col="0"></td>
                                <td class="timeline-cell" data-row="6" data-col="1"></td>
                                <td class="timeline-cell" data-row="6" data-col="2"></td>
                                <td class="timeline-cell" data-row="6" data-col="3"></td>
                                <td class="timeline-cell" data-row="6" data-col="4"></td>
                                <td class="timeline-cell" data-row="6" data-col="5"></td>
                                <td class="timeline-cell" data-row="6" data-col="6"></td>
                                <td class="timeline-cell" data-row="6" data-col="7"></td>
                                <td class="timeline-cell" data-row="6" data-col="8"></td>
                                <td class="timeline-cell" data-row="6" data-col="9"></td>
                                <td class="timeline-cell" data-row="6" data-col="10"></td>
                                <td class="timeline-cell" data-row="6" data-col="11"></td>
                                <td class="timeline-cell" data-row="6" data-col="12"></td>
                                <td class="timeline-cell" data-row="6" data-col="13"></td>
                                <td class="timeline-cell" data-row="6" data-col="14"></td>
                                <td class="timeline-cell" data-row="6" data-col="15"></td>
                            </tr>
                            <tr>
                                <td class="timeline-cell" data-row="7" data-col="0"></td>
                                <td class="timeline-cell" data-row="7" data-col="1"></td>
                                <td class="timeline-cell" data-row="7" data-col="2"></td>
                                <td class="timeline-cell" data-row="7" data-col="3"></td>
                                <td class="timeline-cell" data-row="7" data-col="4"></td>
                                <td class="timeline-cell" data-row="7" data-col="5"></td>
                                <td class="timeline-cell" data-row="7" data-col="6"></td>
                                <td class="timeline-cell" data-row="7" data-col="7"></td>
                                <td class="timeline-cell" data-row="7" data-col="8"></td>
                                <td class="timeline-cell" data-row="7" data-col="9"></td>
                                <td class="timeline-cell" data-row="7" data-col="10"></td>
                                <td class="timeline-cell" data-row="7" data-col="11"></td>
                                <td class="timeline-cell" data-row="7" data-col="12"></td>
                                <td class="timeline-cell" data-row="7" data-col="13"></td>
                                <td class="timeline-cell" data-row="7" data-col="14"></td>
                                <td class="timeline-cell" data-row="7" data-col="15"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 0.5rem; text-align: center; font-size: 0.75rem; color: #9ca3af;">
                    <p id="timeline-instruction">Select an instrument from the panel to start creating</p>
                </div>
                
                <!-- Controls inside timeline -->
                <div class="controls">
                    <h3 style="text-align: center; margin-bottom: 0.5rem; font-size: 1rem;">Controls</h3>
                    
                    <!-- Wave Visualizer -->
                    <div class="wave-visualizer">
                        <div class="wave-label">Audio Waveform</div>
                        <canvas id="wave-canvas" class="wave-canvas"></canvas>
                    </div>
                    
                    <!-- Export Progress Bar -->
                    <div id="export-progress" class="export-progress hidden">
                        <div class="progress-label">Recording in progress...</div>
                        <div class="progress-bar">
                            <div class="progress-fill"></div>
                        </div>
                        <div class="progress-text">0%</div>
                    </div>
                    
                    <div class="controls-grid">
                        <button id="play-button" class="play-button">▶️ Play</button>
                        
                        <div class="tempo-control">
                            <div class="tempo-label">Tempo: <span id="tempo-value">120</span> BPM</div>
                            <div class="tempo-slider-container">
                                <button id="tempo-down" class="tempo-button">⏪ -10</button>
                                <input type="range" id="tempo-slider" class="tempo-slider" min="60" max="200" value="120">
                                <button id="tempo-up" class="tempo-button">+10 ⏩</button>
                            </div>
                            <div class="tempo-presets">
                                <button class="preset-button" data-tempo="80">Slow (80)</button>
                                <button class="preset-button" data-tempo="120">Medium (120)</button>
                                <button class="preset-button" data-tempo="140">Fast (140)</button>
                            </div>
                        </div>
                        
                        <div class="loop-control">
                            <label class="loop-checkbox-label">
                                <input type="checkbox" id="loop-checkbox" checked>
                                <span class="checkmark"></span>
                                🔄 Loop Timeline
                            </label>
                        </div>

                        <div style="text-align: center; font-size: 0.75rem; color: #9ca3af; max-width: 200px;">
                            <p style="font-weight: 500; margin-bottom: 0.25rem;">Tempo Guide:</p>
                            <p id="tempo-guide">Energetic & popular</p>
                        </div>
                    </div>

                    <div style="margin-top: 0.75rem; display: flex; justify-content: center; gap: 0.5rem; flex-wrap: wrap;">
                        <button id="randomizer-button" class="tempo-button" style="background: linear-gradient(145deg, #8844ff 0%, #6633cc 100%); color: #fff;">🎲 Randomize</button>
                        <button id="reset-button" class="tempo-button">🔄 Reset</button>
                        <button id="export-button" class="tempo-button" style="background: linear-gradient(145deg, #00ff88 0%, #00cc6a 100%); color: #000;">💾 Export MP3</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="tooltip" class="tooltip hidden"></div>

    <script>
        class MusicProducer {
            constructor() {
                this.isInitialized = false;
                this.isPlaying = false;
                this.tempo = 120;
                this.currentStep = 0;
                this.isLooping = true;
                this.selectedInstrument = null;
                this.selectedNote = 'C4';
                this.selectedChord = 'single';
                
                // Multiple timelines support
                this.timelines = {};
                this.currentTimelineId = 'timeline-1';
                this.timeline = Array(8).fill(null).map(() => Array(16).fill(null));
                this.timelines[this.currentTimelineId] = {
                    name: 'Beat 1',
                    data: this.timeline
                };
                
                this.instruments = {};
                this.intervalId = null;
                
                // Chord definitions
                this.chords = {
                    single: [],
                    major: [0, 4, 7],
                    minor: [0, 3, 7],
                    seventh: [0, 4, 7, 10],
                    sus2: [0, 2, 7],
                    sus4: [0, 5, 7]
                };
                
                // Available notes
                this.notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                this.octaves = [3, 4, 5];
                
                this.initializeElements();
                this.setupEventListeners();
                this.initializeAudio();
                this.generatePianoRoll();
                this.initializeDefaults();
                this.initializeWaveVisualizer();
                this.updateRowButtons();
                this.updateColumnButtons();
                this.initializeTabs();
                
                // Auto-start playing after initialization
                setTimeout(() => {
                    if (this.isInitialized) {
                        this.play();
                    }
                }, 1500);
            }

            initializeElements() {
                this.playButton = document.getElementById('play-button');
                this.tempoSlider = document.getElementById('tempo-slider');
                this.tempoValue = document.getElementById('tempo-value');
                this.tempoGuide = document.getElementById('tempo-guide');
                this.timelineInstruction = document.getElementById('timeline-instruction');
                this.statusMessage = document.getElementById('status-message');
                this.statusText = document.getElementById('status-text');
                this.tooltip = document.getElementById('tooltip');
                this.audioStatus = document.getElementById('audio-status');
                this.audioStatusText = document.getElementById('audio-status-text');
                this.noteSelector = document.getElementById('note-selector');
                this.pianoRoll = document.getElementById('piano-roll');
                this.selectedNoteInfo = document.getElementById('selected-note-info');
                this.waveCanvas = document.getElementById('wave-canvas');
                this.waveCtx = this.waveCanvas.getContext('2d');
                
                this.instrumentButtons = document.querySelectorAll('.instrument-button');
                this.timelineCells = document.querySelectorAll('.timeline-cell');
                this.chordButtons = document.querySelectorAll('.chord-button');
                this.addRowBtn = document.getElementById('add-row-btn');
                this.removeRowBtn = document.getElementById('remove-row-btn');
                this.addColumnBtn = document.getElementById('add-column-btn');
                this.removeColumnBtn = document.getElementById('remove-column-btn');
                this.exportBtn = document.getElementById('export-button');
                this.randomizerBtn = document.getElementById('randomizer-button');
                this.exportProgress = document.getElementById('export-progress');
                this.progressFill = document.querySelector('.progress-fill');
                this.progressText = document.querySelector('.progress-text');
                this.loopCheckbox = document.getElementById('loop-checkbox');
                this.timelineTable = document.querySelector('.timeline-table tbody');
                this.tabsList = document.getElementById('tabs-list');
                this.addTabBtn = document.getElementById('add-tab-btn');
            }

            generatePianoRoll() {
                this.pianoRoll.innerHTML = '';
                
                this.octaves.forEach(octave => {
                    this.notes.forEach(note => {
                        const noteName = `${note}${octave}`;
                        const button = document.createElement('button');
                        button.className = 'note-button';
                        button.textContent = noteName;
                        button.dataset.note = noteName;
                        button.addEventListener('click', () => this.selectNote(noteName));
                        this.pianoRoll.appendChild(button);
                    });
                });
            }

            initializeDefaults() {
                // Set default selections
                this.selectNote('C4');
                this.selectChord('single');
                this.updateNoteInfo();
            }

            initializeWaveVisualizer() {
                this.resizeCanvas();
                window.addEventListener('resize', () => this.resizeCanvas());
                
                // Create an analyser to get audio data
                this.analyser = new Tone.Analyser('waveform', 1024);
                Tone.Destination.connect(this.analyser);
                
                this.animateWave();
            }

            resizeCanvas() {
                const rect = this.waveCanvas.getBoundingClientRect();
                this.waveCanvas.width = rect.width * window.devicePixelRatio;
                this.waveCanvas.height = rect.height * window.devicePixelRatio;
                this.waveCtx.scale(window.devicePixelRatio, window.devicePixelRatio);
            }

            animateWave() {
                this.waveCtx.clearRect(0, 0, this.waveCanvas.width, this.waveCanvas.height);
                
                const width = this.waveCanvas.width / window.devicePixelRatio;
                const height = this.waveCanvas.height / window.devicePixelRatio;
                const centerY = height / 2;
                
                if (this.analyser) {
                    // Get real audio data
                    const waveform = this.analyser.getValue();
                    const bufferLength = waveform.length;
                    
                    this.waveCtx.beginPath();
                    this.waveCtx.strokeStyle = this.isPlaying ? '#00ff88' : '#333333';
                    this.waveCtx.lineWidth = this.isPlaying ? 3 : 2;
                    
                    const sliceWidth = width / bufferLength;
                    let x = 0;
                    
                    for (let i = 0; i < bufferLength; i++) {
                        const v = waveform[i];
                        const y = centerY + (v * height * 0.3);
                        
                        if (i === 0) {
                            this.waveCtx.moveTo(x, y);
                        } else {
                            this.waveCtx.lineTo(x, y);
                        }
                        
                        x += sliceWidth;
                    }
                    
                    this.waveCtx.stroke();
                    
                    // Add glow effect when playing
                    if (this.isPlaying) {
                        this.waveCtx.shadowColor = '#00ff88';
                        this.waveCtx.shadowBlur = 15;
                        this.waveCtx.stroke();
                        this.waveCtx.shadowBlur = 0;
                    }
                } else {
                    // Fallback to animated wave if analyser not available
                    const time = Date.now() * 0.001;
                    const amplitude = this.isPlaying ? 20 : 5;
                    const frequency = 0.02;
                    
                    this.waveCtx.beginPath();
                    this.waveCtx.strokeStyle = this.isPlaying ? '#00ff88' : '#333333';
                    this.waveCtx.lineWidth = this.isPlaying ? 3 : 2;
                    
                    for (let x = 0; x < width; x += 2) {
                        const y = centerY + Math.sin(x * frequency + time) * amplitude;
                        if (x === 0) {
                            this.waveCtx.moveTo(x, y);
                        } else {
                            this.waveCtx.lineTo(x, y);
                        }
                    }
                    
                    this.waveCtx.stroke();
                }
                
                requestAnimationFrame(() => this.animateWave());
            }

            setupEventListeners() {
                // Instrument selection
                this.instrumentButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const instrument = button.dataset.instrument;
                        this.selectInstrument(instrument);
                    });
                });

                // Timeline clicks
                this.timelineCells.forEach(cell => {
                    cell.addEventListener('click', (e) => {
                        const row = parseInt(cell.dataset.row);
                        const col = parseInt(cell.dataset.col);
                        this.handleTimelineCellClick(row, col, e);
                    });
                });

                // Play/Pause
                this.playButton.addEventListener('click', () => {
                    this.togglePlayPause();
                });

                // Tempo controls
                this.tempoSlider.addEventListener('input', (e) => {
                    this.setTempo(parseInt(e.target.value));
                });

                document.getElementById('tempo-down').addEventListener('click', () => {
                    this.setTempo(Math.max(60, this.tempo - 10));
                });

                document.getElementById('tempo-up').addEventListener('click', () => {
                    this.setTempo(Math.min(200, this.tempo + 10));
                });

                // Preset buttons
                document.querySelectorAll('.preset-button').forEach(button => {
                    button.addEventListener('click', () => {
                        this.setTempo(parseInt(button.dataset.tempo));
                    });
                });

                // Chord selection
                this.chordButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        this.selectChord(button.dataset.chord);
                    });
                });

                // Loop checkbox
                this.loopCheckbox.addEventListener('change', (e) => {
                    this.isLooping = e.target.checked;
                    this.showSuggestion(this.isLooping ? "Looping enabled - timeline will repeat" : "Looping disabled - timeline will play once");
                    
                    // If currently playing, restart with new loop setting
                    if (this.isPlaying) {
                        this.stop();
                        setTimeout(() => {
                            this.play();
                        }, 100);
                    }
                });

                // Tab controls
                this.addTabBtn.addEventListener('click', () => {
                    this.addNewTab();
                });

                // Other buttons
                document.getElementById('reset-button').addEventListener('click', () => {
                    this.reset();
                });

                // Row control buttons
                this.addRowBtn.addEventListener('click', () => {
                    this.addRow();
                });

                this.removeRowBtn.addEventListener('click', () => {
                    this.removeRow();
                });

                this.addColumnBtn.addEventListener('click', () => {
                    this.addColumn();
                });

                this.removeColumnBtn.addEventListener('click', () => {
                    this.removeColumn();
                });

                this.exportBtn.addEventListener('click', () => {
                    this.exportBeat();
                });

                this.randomizerBtn.addEventListener('click', () => {
                    this.randomizeTimeline();
                });
            }

            async initializeAudio() {
                try {
                    // Show audio initialization message
                    this.updateAudioStatus("🔇 Click anywhere to enable audio", "#ef4444");
                    
                    // Add click listener to initialize audio on first user interaction
                    const initAudio = async () => {
                        try {
                            this.updateAudioStatus("🔄 Initializing audio...", "#f59e0b");
                            await Tone.start();
                            this.setupInstruments();
                            this.isInitialized = true;
                            this.updateAudioStatus("🔊 Audio ready! Select an instrument to start.", "#10b981");
                            this.showStatus("Audio ready! Select an instrument to start.");
                            console.log('Audio engine initialized');
                            
                            // Remove the click listener after initialization
                            document.removeEventListener('click', initAudio);
                            document.removeEventListener('touchstart', initAudio);
                        } catch (error) {
                            console.error('Failed to initialize audio engine:', error);
                            this.updateAudioStatus("❌ Audio failed. Refresh and try again.", "#ef4444");
                            this.showStatus("Audio initialization failed. Please refresh and try again.");
                        }
                    };
                    
                    // Listen for user interaction
                    document.addEventListener('click', initAudio);
                    document.addEventListener('touchstart', initAudio);
                    
                } catch (error) {
                    console.error('Failed to initialize audio engine:', error);
                    this.updateAudioStatus("❌ Audio failed. Refresh and try again.", "#ef4444");
                    this.showStatus("Audio initialization failed. Please refresh and try again.");
                }
            }

            updateAudioStatus(message, color = "#9ca3af") {
                this.audioStatusText.textContent = message;
                this.audioStatus.style.backgroundColor = color;
            }

            setupInstruments() {
                // Drum kit
                this.instruments.drums = {
                    kick: new Tone.MembraneSynth({
                        pitchDecay: 0.05,
                        octaves: 10,
                        oscillator: { type: 'triangle' },
                        envelope: { attack: 0.01, decay: 0.3, sustain: 0.01, release: 0.3 }
                    }).toDestination(),
                    
                    snare: new Tone.NoiseSynth({
                        noise: { type: 'white' },
                        envelope: { attack: 0.01, decay: 0.2, sustain: 0.01, release: 0.2 }
                    }).toDestination(),
                    
                    hihat: new Tone.NoiseSynth({
                        noise: { type: 'white' },
                        envelope: { attack: 0.01, decay: 0.1, sustain: 0.01, release: 0.1 }
                    }).toDestination()
                };

                // Piano - using DuoSynth for realistic piano sound
                this.instruments.piano = new Tone.DuoSynth({
                    vibratoAmount: 0.1,
                    vibratoRate: 2,
                    harmonicity: 1.5,
                    voice0: {
                        oscillator: { type: 'sawtooth' },
                        envelope: {
                            attack: 0.01,
                            decay: 0.3,
                            sustain: 0.4,
                            release: 1.2
                        },
                        filterEnvelope: {
                            attack: 0.01,
                            decay: 0.4,
                            sustain: 0.2,
                            release: 0.8,
                            baseFrequency: 200,
                            octaves: 3
                        }
                    },
                    voice1: {
                        oscillator: { type: 'triangle' },
                        envelope: {
                            attack: 0.01,
                            decay: 0.3,
                            sustain: 0.4,
                            release: 1.2
                        },
                        filterEnvelope: {
                            attack: 0.01,
                            decay: 0.4,
                            sustain: 0.2,
                            release: 0.8,
                            baseFrequency: 200,
                            octaves: 3
                        }
                    }
                }).chain(
                    new Tone.Filter(2000, 'lowpass'),
                    new Tone.Reverb(0.3)
                ).toDestination();


                // Synth - dreamy and soft
                this.instruments.synth = new Tone.Synth({
                    oscillator: { type: 'sine' },
                    envelope: { 
                        attack: 0.3, 
                        decay: 0.5, 
                        sustain: 0.6, 
                        release: 2.0 
                    }
                }).chain(
                    new Tone.Filter(800, 'lowpass'),
                    new Tone.Chorus(4, 2.5, 0.5),
                    new Tone.Reverb({
                        decay: 3,
                        wet: 0.4
                    }),
                    new Tone.Filter(2000, 'lowpass')
                ).toDestination();

                // Acoustic Guitar - using FMSynth for plucked string sound
                this.instruments.guitar = new Tone.FMSynth({
                    harmonicity: 2.5,
                    modulationIndex: 3,
                    oscillator: {
                        type: 'sawtooth'
                    },
                    envelope: {
                        attack: 0.01,
                        decay: 0.2,
                        sustain: 0.1,
                        release: 1.2
                    },
                    modulation: {
                        type: 'square'
                    },
                    modulationEnvelope: {
                        attack: 0.01,
                        decay: 0.1,
                        sustain: 0.1,
                        release: 0.3,
                        baseFrequency: 80,
                        octaves: 3
                    }
                }).chain(
                    new Tone.Filter(800, 'lowpass'),
                    new Tone.Reverb({
                        decay: 1.0,
                        wet: 0.2
                    }),
                    new Tone.Filter(2000, 'lowpass')
                ).toDestination();
            }

            selectInstrument(instrument) {
                this.selectedInstrument = instrument;
                
                // Update UI
                this.instrumentButtons.forEach(button => {
                    button.classList.toggle('selected', button.dataset.instrument === instrument);
                });

                // Show/hide note selector
                if (instrument === 'drums') {
                    this.noteSelector.classList.add('hidden');
                    this.timelineInstruction.textContent = `Click on any cell to place ${instrument}`;
                } else {
                    this.noteSelector.classList.remove('hidden');
                    this.timelineInstruction.textContent = `Select notes/chords above, then click cells to place ${instrument}`;
                }

                // Play preview
                this.playInstrument(instrument);
                
                // Show status
                this.showStatus(`${instrument.charAt(0).toUpperCase() + instrument.slice(1)} selected`);
                
                // Show tip
                const tips = {
                    drums: "Start with drums to establish the beat!",
                    piano: "Piano adds beautiful melodies and chords - try different notes!",
                    synth: "Synth creates modern electronic textures - experiment with chords!",
                    guitar: "Electric guitar brings rock energy and electric power - perfect for riffs, solos, and driving rhythms!"
                };
                this.showSuggestion(tips[instrument]);
            }

            selectNote(note) {
                this.selectedNote = note;
                
                // Update UI
                document.querySelectorAll('.note-button').forEach(button => {
                    button.classList.toggle('selected', button.dataset.note === note);
                });

                // Play preview
                this.playInstrument(this.selectedInstrument);
                
                // Update info
                this.updateNoteInfo();
            }

            selectChord(chord) {
                this.selectedChord = chord;
                
                // Update UI
                this.chordButtons.forEach(button => {
                    button.classList.toggle('selected', button.dataset.chord === chord);
                });

                // Play preview
                this.playInstrument(this.selectedInstrument);
                
                // Update info
                this.updateNoteInfo();
            }

            updateNoteInfo() {
                if (this.selectedChord === 'single') {
                    this.selectedNoteInfo.textContent = `Selected: ${this.selectedNote}`;
                } else {
                    const chordNotes = this.getChordNotes(this.selectedNote, this.selectedChord);
                    this.selectedNoteInfo.textContent = `Selected: ${this.selectedNote} ${this.selectedChord} (${chordNotes.join(', ')})`;
                }
            }

            getChordNotes(rootNote, chordType) {
                if (chordType === 'single') return [rootNote];
                
                const rootIndex = this.notes.indexOf(rootNote.replace(/\d+/, ''));
                const octave = parseInt(rootNote.replace(/[A-G#]/, ''));
                const chordIntervals = this.chords[chordType];
                
                return chordIntervals.map(interval => {
                    const noteIndex = (rootIndex + interval) % 12;
                    const noteOctave = octave + Math.floor((rootIndex + interval) / 12);
                    return `${this.notes[noteIndex]}${noteOctave}`;
                });
            }

            playInstrument(instrument) {
                if (!this.isInitialized) {
                    this.showSuggestion("Audio not ready yet. Click anywhere on the page first!");
                    return;
                }

                try {
                    switch (instrument) {
                        case 'drums':
                            this.instruments.drums.kick.triggerAttackRelease('C1', '8n');
                            break;
                        case 'piano':
                        case 'synth':
                        case 'guitar':
                            this.playNotes(instrument, this.selectedNote, this.selectedChord);
                            break;
                    }
                } catch (error) {
                    console.error('Error playing instrument:', error);
                    this.showSuggestion("Audio error. Try refreshing the page.");
                }
            }

            playNotes(instrument, rootNote, chordType) {
                try {
                    const notes = this.getChordNotes(rootNote, chordType);
                    const instrumentObj = this.instruments[instrument];
                    
                    if (!instrumentObj) {
                        console.error(`Instrument ${instrument} not found in instruments object`);
                        return;
                    }
                    
                    notes.forEach(note => {
                        if (instrumentObj && typeof instrumentObj.triggerAttackRelease === 'function') {
                            instrumentObj.triggerAttackRelease(note, '8n');
                        }
                    });
                } catch (error) {
                    console.error('Error in playNotes:', error, { instrument, rootNote, chordType });
                }
            }

            handleTimelineCellClick(row, col, event) {
                const cell = this.timeline[row][col];
                
                if (cell) {
                    // Cell has sound - show options
                    this.showCellOptions(row, col, cell, event);
                } else {
                    // Empty cell - add sound if instrument selected
                    if (this.selectedInstrument) {
                        this.timeline[row][col] = {
                            instrument: this.selectedInstrument,
                            note: this.selectedNote,
                            chord: this.selectedChord
                        };
                        this.showSuggestion(`${this.selectedInstrument} added to timeline`);
                        this.updateTimelineDisplay();
                        this.playInstrument(this.selectedInstrument);
                    } else {
                        this.showSuggestion("Please select an instrument first");
                    }
                }
            }

            showCellOptions(row, col, cell, event) {
                // Create a simple context menu or modal
                const cellElement = event.target;
                const rect = cellElement.getBoundingClientRect();
                
                // Create options overlay
                const optionsOverlay = document.createElement('div');
                optionsOverlay.className = 'cell-options-overlay';
                optionsOverlay.style.cssText = `
                    position: fixed;
                    top: ${rect.top + rect.height + 5}px;
                    left: ${rect.left}px;
                    background: linear-gradient(145deg, #2a2a2a 0%, #1a1a1a 100%);
                    border: 1px solid #00ff88;
                    border-radius: 8px;
                    padding: 8px;
                    z-index: 1000;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
                    display: flex;
                    flex-direction: column;
                    gap: 4px;
                    min-width: 120px;
                `;
                
                // Current sound info
                const info = document.createElement('div');
                info.style.cssText = `
                    font-size: 0.75rem;
                    color: #00ff88;
                    text-align: center;
                    margin-bottom: 4px;
                    padding: 4px;
                    background: rgba(0, 255, 136, 0.1);
                    border-radius: 4px;
                `;
                info.textContent = `${cell.instrument} ${cell.note || ''}`;
                optionsOverlay.appendChild(info);
                
                // Change sound button
                const changeBtn = document.createElement('button');
                changeBtn.style.cssText = `
                    background: linear-gradient(145deg, #4a4a4a 0%, #3a3a3a 100%);
                    border: 1px solid #666;
                    color: white;
                    padding: 6px 8px;
                    border-radius: 4px;
                    font-size: 0.75rem;
                    cursor: pointer;
                    transition: all 0.2s;
                `;
                changeBtn.textContent = '🔄 Change';
                changeBtn.onmouseover = () => changeBtn.style.background = 'linear-gradient(145deg, #5a5a5a 0%, #4a4a4a 100%)';
                changeBtn.onmouseout = () => changeBtn.style.background = 'linear-gradient(145deg, #4a4a4a 0%, #3a3a3a 100%)';
                changeBtn.onclick = () => {
                    this.changeCellSound(row, col);
                    document.body.removeChild(optionsOverlay);
                };
                optionsOverlay.appendChild(changeBtn);
                
                // Remove sound button
                const removeBtn = document.createElement('button');
                removeBtn.style.cssText = `
                    background: linear-gradient(145deg, #ff6b6b 0%, #ee5a52 100%);
                    border: 1px solid #ff6b6b;
                    color: white;
                    padding: 6px 8px;
                    border-radius: 4px;
                    font-size: 0.75rem;
                    cursor: pointer;
                    transition: all 0.2s;
                `;
                removeBtn.textContent = '🗑️ Remove';
                removeBtn.onmouseover = () => removeBtn.style.background = 'linear-gradient(145deg, #ff7b7b 0%, #ff6a6a 100%)';
                removeBtn.onmouseout = () => removeBtn.style.background = 'linear-gradient(145deg, #ff6b6b 0%, #ee5a52 100%)';
                removeBtn.onclick = () => {
                    this.removeCellSound(row, col);
                    document.body.removeChild(optionsOverlay);
                };
                optionsOverlay.appendChild(removeBtn);
                
                // Add to page
                document.body.appendChild(optionsOverlay);
                
                // Remove overlay when clicking outside
                const removeOverlay = (e) => {
                    if (!optionsOverlay.contains(e.target)) {
                        document.body.removeChild(optionsOverlay);
                        document.removeEventListener('click', removeOverlay);
                    }
                };
                setTimeout(() => document.addEventListener('click', removeOverlay), 100);
            }

            changeCellSound(row, col) {
                // Use currently selected instrument/note/chord
                if (this.selectedInstrument) {
                    this.timeline[row][col] = {
                        instrument: this.selectedInstrument,
                        note: this.selectedNote,
                        chord: this.selectedChord
                    };
                    this.showSuggestion(`Sound changed to ${this.selectedInstrument}`);
                    this.updateTimelineDisplay();
                    this.playInstrument(this.selectedInstrument);
                } else {
                    this.showSuggestion("Please select an instrument first");
                }
            }

            removeCellSound(row, col) {
                this.timeline[row][col] = null;
                this.showSuggestion("Sound removed from timeline");
                this.updateTimelineDisplay();
            }

            toggleTimelineCell(row, col) {
                // Keep this method for backward compatibility
                this.handleTimelineCellClick(row, col, { target: this.timelineCells.find(cell => 
                    parseInt(cell.dataset.row) === row && parseInt(cell.dataset.col) === col
                ) });
            }

            updateTimelineDisplay() {
                this.timelineCells.forEach(cell => {
                    const row = parseInt(cell.dataset.row);
                    const col = parseInt(cell.dataset.col);
                    const data = this.timeline[row][col];
                    
                    cell.classList.remove('has-instrument', 'drums', 'piano', 'synth', 'note-cell');
                    cell.innerHTML = '+';
                    
                    if (data) {
                        cell.classList.add('has-instrument', data.instrument, 'note-cell');
                        const emojis = { drums: '🥁', piano: '🎹', synth: '🎛️' };
                        
                        if (data.instrument === 'drums') {
                            cell.innerHTML = emojis[data.instrument];
                        } else {
                            const noteDisplay = data.chord === 'single' ? data.note : `${data.note} ${data.chord}`;
                            cell.innerHTML = `
                                <div>${emojis[data.instrument]}</div>
                                <div class="note-display">${noteDisplay}</div>
                            `;
                        }
                    }
                });
            }

            togglePlayPause() {
                if (this.isPlaying) {
                    this.stop();
                } else {
                    this.play();
                }
            }

            play() {
                console.log('Play button clicked, state:', { isInitialized: this.isInitialized, isPlaying: this.isPlaying, currentStep: this.currentStep });
                
                if (!this.isInitialized) {
                    this.showSuggestion("Audio not ready! Click anywhere on the page first to enable audio.");
                    return;
                }
                
                if (this.isPlaying) {
                    console.log('Already playing, stopping');
                    this.stop();
                    return;
                }

                try {
                    // Ensure we have a valid timeline
                    if (!this.timeline || this.timeline.length === 0 || !this.timeline[0] || this.timeline[0].length === 0) {
                        this.showSuggestion("Timeline is empty. Add some sounds first!");
                        return;
                    }
                    
                    console.log('Starting playback, timeline length:', this.timeline[0].length);
                    
                    this.isPlaying = true;
                    this.playButton.textContent = '⏸️ Pause';
                    this.playButton.classList.add('playing');
                    
                    // Reset current step
                    this.currentStep = 0;
                    this.updateStepIndicator();
                    
                    // Start the step loop
                    this.startStepLoop();
                    
                    this.showSuggestion("Great! Now you can hear your creation come to life!");
                } catch (error) {
                    console.error('Error starting playback:', error);
                    this.showSuggestion("Playback error. Try refreshing the page.");
                    this.stop();
                }
            }

            startStepLoop() {
                // Clear any existing timeout
                if (this.stepTimeout) {
                    clearTimeout(this.stepTimeout);
                    this.stepTimeout = null;
                }
                
                const totalSteps = this.timeline[0].length;
                const stepDuration = 60 / this.tempo / 4; // 16th note timing
                
                const playStep = () => {
                    if (!this.isPlaying) {
                        return;
                    }
                    
                    // Play current step
                    this.playCurrentStep();
                    this.updateStepIndicator();
                    
                    // Move to next step
                    this.currentStep++;
                    
                    if (this.currentStep >= totalSteps) {
                        if (this.isLooping) {
                            // Reset to beginning for looping
                            this.currentStep = 0;
                        } else {
                            // Stop if not looping
                            this.stop();
                            return;
                        }
                    }
                    
                    // Schedule next step
                    this.stepTimeout = setTimeout(playStep, stepDuration * 1000);
                };
                
                // Start the loop
                playStep();
            }

            stop() {
                this.isPlaying = false;
                this.playButton.textContent = '▶️ Play';
                this.playButton.classList.remove('playing');
                
                Tone.Transport.stop();
                Tone.Transport.cancel();
                
                // Clear step timeout
                if (this.stepTimeout) {
                    clearTimeout(this.stepTimeout);
                    this.stepTimeout = null;
                }
                
                if (this.intervalId) {
                    clearInterval(this.intervalId);
                    this.intervalId = null;
                }
                
                this.currentStep = 0;
                this.updateStepIndicator();
            }

            playCurrentStep() {
                try {
                    // Ensure currentStep is within bounds
                    const maxStep = this.timeline[0] ? this.timeline[0].length - 1 : 0;
                    if (this.currentStep > maxStep) {
                        this.currentStep = 0;
                    }
                    
                    this.timeline.forEach((row, rowIndex) => {
                        const data = row[this.currentStep];
                        if (data) {
                            if (data.instrument === 'drums') {
                                if (this.instruments.drums && this.instruments.drums.kick) {
                                    this.instruments.drums.kick.triggerAttackRelease('C1', '8n');
                                }
                            } else {
                                this.playNotes(data.instrument, data.note, data.chord);
                            }
                        }
                    });
                } catch (error) {
                    console.error('Error in playCurrentStep:', error);
                }
            }

            addRow() {
                const newRowIndex = this.timeline.length;
                const columnCount = this.timeline[0] ? this.timeline[0].length : 16;
                this.timeline.push(Array(columnCount).fill(null));
                
                // Create new table row
                const newRow = document.createElement('tr');
                for (let col = 0; col < columnCount; col++) {
                    const cell = document.createElement('td');
                    cell.className = 'timeline-cell';
                    cell.setAttribute('data-row', newRowIndex);
                    cell.setAttribute('data-col', col);
                    cell.addEventListener('click', () => {
                        const row = parseInt(cell.dataset.row);
                        const col = parseInt(cell.dataset.col);
                        this.toggleTimelineCell(row, col);
                    });
                    newRow.appendChild(cell);
                }
                
                this.timelineTable.appendChild(newRow);
                this.updateTimelineCells();
                this.updateRowButtons();
            }

            removeRow() {
                if (this.timeline.length <= 1) {
                    this.showSuggestion("You need at least one row to create music!");
                    return;
                }
                
                // Remove last row from data
                this.timeline.pop();
                
                // Remove last row from DOM
                const lastRow = this.timelineTable.lastElementChild;
                if (lastRow) {
                    this.timelineTable.removeChild(lastRow);
                }
                
                this.updateTimelineCells();
                this.updateRowButtons();
            }

            updateTimelineCells() {
                this.timelineCells = document.querySelectorAll('.timeline-cell');
            }

            updateRowButtons() {
                // Disable remove button if only 1 row left
                this.removeRowBtn.disabled = this.timeline.length <= 1;
            }

            addColumn() {
                const newColIndex = this.timeline[0].length;
                
                // Add new column to all rows in data
                this.timeline.forEach(row => {
                    row.push(null);
                });
                
                // Add new column to all rows in DOM
                const rows = this.timelineTable.querySelectorAll('tr');
                rows.forEach((row, rowIndex) => {
                    const cell = document.createElement('td');
                    cell.className = 'timeline-cell';
                    cell.setAttribute('data-row', rowIndex);
                    cell.setAttribute('data-col', newColIndex);
                    cell.addEventListener('click', () => {
                        const row = parseInt(cell.dataset.row);
                        const col = parseInt(cell.dataset.col);
                        this.toggleTimelineCell(row, col);
                    });
                    row.appendChild(cell);
                });
                
                this.updateTimelineCells();
                this.updateColumnButtons();
            }

            removeColumn() {
                if (this.timeline[0].length <= 1) {
                    this.showSuggestion("You need at least one column to create music!");
                    return;
                }
                
                // Remove last column from all rows in data
                this.timeline.forEach(row => {
                    row.pop();
                });
                
                // Remove last column from all rows in DOM
                const rows = this.timelineTable.querySelectorAll('tr');
                rows.forEach(row => {
                    const lastCell = row.lastElementChild;
                    if (lastCell) {
                        row.removeChild(lastCell);
                    }
                });
                
                // Adjust current step if it's beyond the new length
                const maxStep = this.timeline[0].length - 1;
                if (this.currentStep > maxStep) {
                    this.currentStep = maxStep;
                    this.updateStepIndicator();
                }
                
                this.updateTimelineCells();
                this.updateColumnButtons();
            }

            updateColumnButtons() {
                // Disable remove button if only 1 column left
                this.removeColumnBtn.disabled = this.timeline[0].length <= 1;
            }

            async exportBeat() {
                if (!this.isInitialized) {
                    this.showSuggestion("Audio not ready yet. Click anywhere on the page first!");
                    return;
                }

                try {
                    this.showSuggestion("Recording your beat... This may take a moment.");
                    this.exportBtn.textContent = "⏹️ Recording...";
                    this.exportBtn.disabled = true;
                    
                    // Show progress bar
                    this.exportProgress.classList.remove('hidden');
                    this.progressFill.style.width = '0%';
                    this.progressText.textContent = '0%';

                    // Calculate total duration (4 beats per measure, 16th notes)
                    const totalSteps = this.timeline[0].length;
                    const duration = (totalSteps * 4) / this.tempo; // Duration in seconds
                    
                    // Create a recorder and connect it to the master output
                    const recorder = new Tone.Recorder();
                    Tone.Destination.connect(recorder);
                    
                    // Start recording
                    recorder.start();
                    
                    // Play the beat
                    this.play();
                    
                    // Update progress bar
                    const progressInterval = setInterval(() => {
                        const elapsed = (Date.now() - startTime) / 1000;
                        const progress = Math.min((elapsed / duration) * 100, 100);
                        this.progressFill.style.width = `${progress}%`;
                        this.progressText.textContent = `${Math.round(progress)}%`;
                    }, 100);
                    
                    const startTime = Date.now();
                    
                    // Wait for the duration plus a bit of buffer
                    await new Promise(resolve => setTimeout(resolve, (duration + 1) * 1000));
                    
                    // Stop recording and playing
                    this.stop();
                    const recording = await recorder.stop();
                    
                    // Clear progress interval
                    clearInterval(progressInterval);
                    
                    // Convert WAV to MP3 using a simple approach
                    // Note: This is a basic conversion - for production use, consider using a proper MP3 encoder
                    const wavBlob = recording;
                    const mp3Blob = await this.convertWavToMp3(wavBlob);
                    
                    // Create download link
                    const url = URL.createObjectURL(mp3Blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `beat_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.mp3`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    // Disconnect recorder
                    Tone.Destination.disconnect(recorder);
                    
                    // Hide progress bar
                    this.exportProgress.classList.add('hidden');
                    
                    this.showSuggestion("Beat exported successfully! Check your downloads folder.");
                    
                } catch (error) {
                    console.error('Export error:', error);
                    this.showSuggestion("Export failed. Please try again.");
                    this.exportProgress.classList.add('hidden');
                } finally {
                    this.exportBtn.textContent = "💾 Export MP3";
                    this.exportBtn.disabled = false;
                }
            }

            async convertWavToMp3(wavBlob) {
                // Simple approach: return the WAV blob as-is with MP3 extension
                // For a real MP3 conversion, you would need to use a library like lamejs
                // This is a placeholder that maintains the WAV format but with MP3 extension
                return wavBlob;
            }

            randomizeTimeline() {
                console.log('Starting randomize, current state:', { isPlaying: this.isPlaying, currentStep: this.currentStep });
                
                // Stop any current playback to prevent conflicts
                if (this.isPlaying) {
                    console.log('Stopping current playback before randomize');
                    this.stop();
                }
                
                // Clear any existing timeouts
                if (this.stepTimeout) {
                    clearTimeout(this.stepTimeout);
                    this.stepTimeout = null;
                }
                
                // Clear existing timeline
                this.timeline.forEach(row => {
                    row.fill(null);
                });

                // Available instruments
                const instruments = ['drums', 'piano', 'synth', 'guitar'];
                const notes = ['C3', 'D3', 'E3', 'F3', 'G3', 'A3', 'B3', 'C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4'];
                const chords = ['single', 'major', 'minor', 'seventh', 'sus2', 'sus4'];

                // Randomize each cell with 30% probability of having an instrument
                this.timeline.forEach((row, rowIndex) => {
                    row.forEach((cell, colIndex) => {
                        if (Math.random() < 0.3) { // 30% chance
                            const instrument = instruments[Math.floor(Math.random() * instruments.length)];
                            
                            if (instrument === 'drums') {
                                this.timeline[rowIndex][colIndex] = {
                                    instrument: 'drums',
                                    note: null,
                                    chord: null
                                };
                            } else {
                                const note = notes[Math.floor(Math.random() * notes.length)];
                                const chord = chords[Math.floor(Math.random() * chords.length)];
                                
                                this.timeline[rowIndex][colIndex] = {
                                    instrument: instrument,
                                    note: note,
                                    chord: chord
                                };
                            }
                        }
                    });
                });

                // Reset playback state completely
                this.currentStep = 0;
                this.isPlaying = false;
                this.playButton.textContent = '▶️ Play';
                this.playButton.classList.remove('playing');
                
                // Clear any remaining timeouts
                if (this.stepTimeout) {
                    clearTimeout(this.stepTimeout);
                    this.stepTimeout = null;
                }
                
                // Update the display
                this.updateTimelineDisplay();
                this.updateStepIndicator();
                
                console.log('Randomize complete, new state:', { isPlaying: this.isPlaying, currentStep: this.currentStep });
                
                this.showSuggestion("Timeline randomized! Press play to hear your new beat.");
            }

            updateStepIndicator() {
                this.timelineCells.forEach(cell => {
                    const col = parseInt(cell.dataset.col);
                    cell.classList.toggle('current-step', col === this.currentStep);
                });
            }

            setTempo(newTempo) {
                this.tempo = newTempo;
                this.tempoValue.textContent = newTempo;
                this.tempoSlider.value = newTempo;
                Tone.Transport.bpm.value = newTempo;
                
                // Update tempo guide
                let guide = '';
                if (newTempo < 100) guide = 'Relaxed & smooth';
                else if (newTempo < 120) guide = 'Moderate & groovy';
                else if (newTempo < 140) guide = 'Energetic & popular';
                else guide = 'Fast & intense';
                
                this.tempoGuide.textContent = guide;
                
                // If currently playing, restart with new tempo
                if (this.isPlaying) {
                    this.stop();
                    this.play();
                }
                
                // Show tempo suggestions
                if (newTempo < 80) {
                    this.showSuggestion("Very slow tempo! Great for ballads and ambient music.");
                } else if (newTempo > 160) {
                    this.showSuggestion("High energy tempo! Perfect for dance and electronic music.");
                } else if (newTempo >= 120 && newTempo <= 140) {
                    this.showSuggestion("Perfect tempo range! This works well for most genres.");
                }
            }

            showSuggestion(message) {
                this.tooltip.textContent = message;
                this.tooltip.classList.remove('hidden');
                this.tooltip.style.left = '50%';
                this.tooltip.style.top = '20px';
                this.tooltip.style.transform = 'translateX(-50%)';
                
                setTimeout(() => {
                    this.tooltip.classList.add('hidden');
                }, 3000);
            }

            showStatus(message) {
                this.statusText.textContent = message;
                this.statusMessage.classList.remove('hidden');
                
                setTimeout(() => {
                    this.statusMessage.classList.add('hidden');
                }, 2000);
            }

            reset() {
                this.stop();
                this.timeline = Array(8).fill(null).map(() => Array(16).fill(null));
                this.updateTimelineDisplay();
                this.selectedInstrument = null;
                this.selectedNote = 'C4';
                this.selectedChord = 'single';
                this.instrumentButtons.forEach(button => button.classList.remove('selected'));
                this.chordButtons.forEach(button => button.classList.remove('selected'));
                document.querySelectorAll('.note-button').forEach(button => button.classList.remove('selected'));
                this.noteSelector.classList.add('hidden');
                this.timelineInstruction.textContent = 'Select an instrument from the panel to start creating';
                this.updateNoteInfo();
                this.showSuggestion("Starting fresh! Try a completely different approach this time.");
            }

            // Tab Management Methods
            initializeTabs() {
                this.renderTabs();
            }

            renderTabs() {
                this.tabsList.innerHTML = '';
                
                Object.keys(this.timelines).forEach(timelineId => {
                    const timeline = this.timelines[timelineId];
                    const isActive = timelineId === this.currentTimelineId;
                    
                    const tabElement = document.createElement('div');
                    tabElement.className = `timeline-tab ${isActive ? 'active' : ''}`;
                    tabElement.dataset.timelineId = timelineId;
                    
                    tabElement.innerHTML = `
                        <span class="tab-name">${timeline.name}</span>
                        <button class="tab-rename-btn" title="Rename">✏️</button>
                        <button class="tab-close-btn" title="Close">×</button>
                    `;
                    
                    // Tab click to switch
                    tabElement.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('tab-rename-btn') && !e.target.classList.contains('tab-close-btn')) {
                            this.switchToTab(timelineId);
                        }
                    });
                    
                    // Rename button
                    const renameBtn = tabElement.querySelector('.tab-rename-btn');
                    renameBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.renameTab(timelineId);
                    });
                    
                    // Close button
                    const closeBtn = tabElement.querySelector('.tab-close-btn');
                    closeBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.closeTab(timelineId);
                    });
                    
                    this.tabsList.appendChild(tabElement);
                });
            }

            addNewTab() {
                const newId = `timeline-${Date.now()}`;
                const newTimeline = Array(8).fill(null).map(() => Array(16).fill(null));
                
                this.timelines[newId] = {
                    name: `Beat ${Object.keys(this.timelines).length + 1}`,
                    data: newTimeline
                };
                
                this.switchToTab(newId);
                this.showSuggestion(`New timeline "${this.timelines[newId].name}" created!`);
            }

            switchToTab(timelineId) {
                if (this.timelines[timelineId]) {
                    // Save current timeline data
                    this.timelines[this.currentTimelineId].data = this.timeline;
                    
                    // Switch to new timeline
                    this.currentTimelineId = timelineId;
                    this.timeline = this.timelines[timelineId].data;
                    
                    // Stop current playback
                    if (this.isPlaying) {
                        this.stop();
                    }
                    
                    // Update display
                    this.updateTimelineDisplay();
                    this.renderTabs();
                    this.updateStepIndicator();
                    
                    this.showSuggestion(`Switched to "${this.timelines[timelineId].name}"`);
                }
            }

            renameTab(timelineId) {
                const newName = prompt('Enter new name for this timeline:', this.timelines[timelineId].name);
                if (newName && newName.trim() && newName !== this.timelines[timelineId].name) {
                    this.timelines[timelineId].name = newName.trim();
                    this.renderTabs();
                    this.showSuggestion(`Timeline renamed to "${newName}"`);
                }
            }

            closeTab(timelineId) {
                const timelineCount = Object.keys(this.timelines).length;
                
                if (timelineCount <= 1) {
                    this.showSuggestion("Cannot close the last timeline!");
                    return;
                }
                
                if (confirm(`Are you sure you want to close "${this.timelines[timelineId].name}"?`)) {
                    // Stop playback if closing current tab
                    if (this.isPlaying) {
                        this.stop();
                    }
                    
                    // Delete timeline
                    delete this.timelines[timelineId];
                    
                    // Switch to first available timeline
                    const remainingTimelines = Object.keys(this.timelines);
                    if (remainingTimelines.length > 0) {
                        this.switchToTab(remainingTimelines[0]);
                    }
                    
                    this.showSuggestion("Timeline closed!");
                }
            }
        }

        // Initialize the app when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new MusicProducer();
        });
    </script>
</body>
</html>
